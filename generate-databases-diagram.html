<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./assets/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Noms Â· Database Diagram Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@100..900&family=Geist:wght@100..900&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Geist', 'system-ui', 'sans-serif'],
                        mono: ['Geist Mono', 'monospace'],
                    },
                },
            },
        };
    </script>
    <style>
        .hidden {
            display: none;
        }

        /* Custom styles */
        body {
            font-family: 'Geist', sans-serif;
            /* Geist for body text */
        }

        h1 {
            font-family: 'Geist Mono', monospace;
            /* Geist Mono for headings */
        }

        h2,
        .font-mono {
            font-family: 'Geist Mono', monospace;
        }

        /* Custom select styles */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25rem;
            padding-right: 2.5rem;
        }

        select option:first-child {
            color: #9CA3AF;
        }

        select.border-black {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23000000'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        }

        .tool-description {
            font-family: 'Geist Mono', monospace;
            font-size: 1.2rem;
            text-align: center;
            color: #000;
            padding: 1rem;
            margin: 1.5rem auto;
            max-width: 600px;
        }

        /* Textarea for diagram output */
        #diagramOutput {
            font-family: 'Geist Mono', monospace;
            width: 100%;
            height: 300px;
            /* Adjust as needed */
            resize: vertical;
            /* Allow vertical resizing */
            border: 4px solid #000;
            padding: 0.5rem;
            background-color: #fff;
            color: #000;
            box-shadow: 4px 4px 0 0 #000;
            margin-top: 1rem;
            /* Consistent spacing */
        }

        /* New styles for pasteMessage anchor tags */
        #pasteMessage a {
            all: unset;
            color: inherit;
            text-decoration: underline;
            cursor: pointer;
            font-weight: normal;
        }
    </style>
</head>

<body>
    <div id="header-container" view-transition-group></div>
    <div id="root" class="min-h-screen bg-gray-100 p-8">
        <div id="auth-banner" class="hidden bg-red-500 text-white p-4 text-center mb-8">
            You need to be logged in to use this tool. Please log in above.
        </div>
        <div class="mx-auto max-w-2xl">
            <div class="mb-8 flex items-center justify-center space-x-4">
                <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                </svg>
                <h1 class="text-3xl font-black uppercase tracking-wider">
                    Databases Diagram Generator
                </h1>
            </div>
            <div class="tool-description">
                Generate a DBML/Mermaid representation of your Notion database
                relationships to visualize its structure (ERD).
            </div>

            <div id="main-container" class="rounded-lg border-8 border-black bg-white p-8 shadow-[8px_8px_0_0_#000]">
                <form id="diagram-form" class="space-y-6">
                    <details open class="rounded-lg border-4 border-black p-4">
                        <summary class="cursor-pointer font-bold uppercase tracking-wide">
                            Worker Configuration
                        </summary>
                        <div class="mt-4 space-y-4">
                            <div class="w-full">
                                <label class="mb-2 block font-bold uppercase tracking-wide" for="workerUrl">Worker
                                    URL</label>
                                <input
                                    class="w-full border-4 border-black bg-white px-3 py-2 text-black placeholder:text-gray-500 focus:outline-none focus:ring-4 focus:ring-[#FEA97F] disabled:cursor-not-allowed disabled:opacity-50"
                                    type="url" id="workerUrl" name="workerUrl"
                                    placeholder="Enter your Worker URL (e.g., https://your-worker.workers.dev)"
                                    required />
                                <p id="workerUrl-error" class="mt-1 hidden text-sm font-bold text-red-500"></p>
                            </div>
                            <div class="w-full">
                                <label class="mb-2 block font-bold uppercase tracking-wide" for="workerToken">Worker
                                    Token</label>
                                <input
                                    class="w-full border-4 border-black bg-white px-3 py-2 text-black placeholder:text-gray-500 focus:outline-none focus:ring-4 focus:ring-[#FEA97F] disabled:cursor-not-allowed disabled:opacity-50"
                                    type="password" id="workerToken" name="workerToken"
                                    placeholder="Enter your Worker Token" required />
                                <p id="workerToken-error" class="mt-1 hidden text-sm font-bold text-red-500"></p>
                            </div>
                        </div>
                    </details>

                    <div id="database-section" class="space-y-6">
                        <!-- Database selection -->
                        <div class="w-full">
                            <div class="flex items-center justify-between mb-2">
                                <label class="font-bold uppercase tracking-wide" for="databaseSelect">Select
                                    Database</label>
                                <button type="button" id="refreshDatabases"
                                    class="text-sm text-[#FEA97F] hover:text-[#fe9665] flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                            <div class="relative">
                                <input type="text" id="databaseSearch" placeholder="Search databases..."
                                    class="w-full border-4 border-black bg-white px-3 py-2 mb-2 text-black placeholder:text-gray-500 focus:outline-none focus:ring-4 focus:ring-[#FEA97F]">
                                <select id="databaseSelect"
                                    class="w-full border-4 border-black bg-white px-3 py-2 text-black focus:outline-none focus:ring-4 focus:ring-[#FEA97F]">
                                    <option value="" class="text-gray-400">-</option>
                                </select>
                            </div>
                            <p id="databaseSelect-error" class="mt-1 hidden text-sm font-bold text-red-500"></p>
                        </div>

                        <!-- New Diagram Type selector -->
                        <fieldset class="border-4 border-black p-4">
                            <legend class="font-bold uppercase tracking-wide">Diagram Type</legend>
                            <label>
                                <input type="radio" name="diagramType" value="dbml" checked>
                                DBML
                            </label>
                            <label class="ml-4">
                                <input type="radio" name="diagramType" value="mermaid">
                                Mermaid ER Diagram
                            </label>
                        </fieldset>

                        <!-- Submit button -->
                        <button type="submit" id="submit-button"
                            class="relative inline-flex items-center justify-center w-full h-12 px-8 py-4 font-bold text-white transition-colors bg-[#FEA97F] hover:bg-[#fe9665] active:bg-[#fe8b51] disabled:pointer-events-none disabled:opacity-50">
                            <div id="loading-spinner" class="absolute inset-0 hidden items-center justify-center">
                                <div class="h-5 w-5 animate-spin rounded-full border-b-2 border-white"></div>
                            </div>
                            <span id="submit-button-text">Generate Diagram</span>
                        </button>
                    </div>
                </form>

                <div id="output-section" class="hidden space-y-6">
                    <h2 class="font-bold uppercase tracking-wide">Diagram Output</h2>
                    <textarea id="diagramOutput" readonly placeholder="Diagram output will appear here..."></textarea>
                    <textarea id="logOutput" readonly placeholder="Logs will appear here..."
                        class="mt-4 w-full h-32 border-4 border-black bg-white p-2 text-black font-mono text-sm"></textarea>
                    <div id="pasteMessage"></div>
                    <button id="copy-button" disabled
                        class="w-full h-12 flex items-center justify-center font-bold text-black transition-colors border-4 border-black bg-white hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        <span>Copy to Clipboard</span>
                    </button>
                    <button id="reset-button"
                        class="hidden w-full h-12 flex items-center justify-center font-bold text-black transition-colors border-4 border-black bg-white hover:bg-gray-100">
                        <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        <span>Generate New Diagram</span>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { getLocalStorageWithExpiry, updateUIHeader, initializeAuth } from './js/auth.js';
        import { OAUTH_HANDLER_URL, WORKER_URL, WORKER_TOKEN } from './js/constants.js';
        import { createHeader } from './js/header.js';

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAuth();

            const WORKER_CONFIG_KEY = 'nomsWorkerConfig';
            let isProcessing = false;
            let notionToken = null;

            document.getElementById('header-container').innerHTML = createHeader();

            // Helper Functions
            function loadWorkerConfig() {
                const workerUrlInput = document.getElementById('workerUrl');
                const workerTokenInput = document.getElementById('workerToken');

                const savedConfig = localStorage.getItem(WORKER_CONFIG_KEY);
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    workerUrlInput.value = config.url;
                    workerTokenInput.value = config.token;
                } else if (WORKER_URL) {
                    workerUrlInput.value = WORKER_URL;
                    if (WORKER_TOKEN) {
                        workerTokenInput.value = WORKER_TOKEN;
                    }
                }
            }

            const saveWorkerConfig = (url, token) => {
                localStorage.setItem(WORKER_CONFIG_KEY, JSON.stringify({ url, token }));
            };

            const checkAuthStatus = async () => {
                const nomsData = getLocalStorageWithExpiry("nomsData");
                if (!nomsData) {
                    document.getElementById('auth-banner').classList.remove('hidden');
                    document.getElementById('submit-button').disabled = true;
                    return;
                }
                notionToken = nomsData.accessToken;
                document.getElementById('submit-button').disabled = false;
                document.getElementById('auth-banner').classList.add('hidden');
            };

            const isWorkerConfigComplete = () => document.getElementById('workerUrl').value.trim() && document.getElementById('workerToken').value.trim();

            const checkWorkerUrl = () => {
                const isComplete = isWorkerConfigComplete();
                document.getElementById('submit-button').disabled = !isComplete;
                if (isComplete) {
                    saveWorkerConfig(document.getElementById('workerUrl').value.trim(), document.getElementById('workerToken').value.trim());
                }
            };

            const addLog = (message) => {
                const timestamp = new Date().toLocaleTimeString();
                document.getElementById('logOutput').value += `[${timestamp}] ${message}\n`;
                document.getElementById('logOutput').scrollTop = document.getElementById('logOutput').scrollHeight;
            };

            const showError = (inputElement, message) => {
                const errorElement = document.getElementById(`${inputElement.name}-error`);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.classList.remove('hidden');
                    inputElement.classList.add('border-red-500');
                }
            };

            const clearError = (inputElement) => {
                const errorElement = document.getElementById(`${inputElement.name}-error`);
                if (errorElement) {
                    errorElement.textContent = '';
                    errorElement.classList.add('hidden');
                    inputElement.classList.remove('border-red-500');
                }
            };

            const resetForm = () => {
                isProcessing = false;
                document.getElementById('output-section').classList.add('hidden');
                document.getElementById('diagram-form').classList.remove('hidden');
                document.getElementById('reset-button').classList.add('hidden');
                document.getElementById('diagramOutput').value = '';
                document.getElementById('logOutput').value = '';
                document.getElementById('pasteMessage').innerHTML = '';
                document.getElementById('pasteMessage').classList.remove('text-sm', 'p-2', 'border-2', 'border-dashed', 'border-gray-500');
                document.getElementById('copy-button').disabled = true;
            };

            const populateDropdowns = (databases) => {
                document.getElementById('databaseSelect').innerHTML = '<option value="">-</option>';
                databases.forEach(db => {
                    const title = db.title?.[0]?.plain_text ?? 'Untitled';
                    const option = document.createElement('option');
                    option.value = db.id;
                    option.textContent = title;
                    document.getElementById('databaseSelect').appendChild(option);
                });
            };

            // API Interaction
            const makeNotionRequest = async (endpoint, options = {}) => {
                if (!isWorkerConfigComplete()) throw new Error('Worker URL and Token are required');
                const url = `${document.getElementById('workerUrl').value.trim()}${endpoint}?token=${encodeURIComponent(document.getElementById('workerToken').value.trim())}`;
                try {
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${notionToken}`,
                            ...options.headers,
                        },
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        const errorMessage = errorData?.message || `API request failed: ${response.status}`;
                        throw new Error(errorMessage);
                    }
                    return await response.json();
                } catch (error) {
                    throw error;
                }
            };

            const getDatabaseInfo = async (databaseId) => {
                addLog(`Fetching database info for ID: ${databaseId}`);
                return makeNotionRequest(`/databases/${databaseId}`);
            };

            const fetchDatabases = async () => {
                if (!isWorkerConfigComplete()) throw new Error('Worker URL and Token are required');
                addLog('Fetching databases...');
                const response = await makeNotionRequest('/search', {
                    method: 'POST',
                    body: JSON.stringify({ filter: { value: "database", property: "object" } })
                });
                localStorage.setItem('nomsDatabases', JSON.stringify(response.results));
                addLog(`Fetched ${response.results.length} databases.`);
                return response.results;
            };

            // Sanitization
            const sanitizeTableName = (name) => (name.replace(/[^a-zA-Z0-9_]+/g, '_')).replace(/^[^a-zA-Z_]/, '_$&');
            const reservedKeywords = new Set(['note', 'table', 'ref', 'enum', 'index', 'indices']);
            const sanitizeColumnName = (name) => {
                let sanitized = name.replace(/[^a-zA-Z0-9_]+/g, '_').replace(/^[^a-zA-Z_]/, '_$&');
                return reservedKeywords.has(sanitized.toLowerCase()) ? `safe_${sanitized}` : sanitized;
            };


            // Core Logic: Database and Property Relationship Extraction
            const extractDatabaseRelationships = async (startingDatabaseId) => {
                const visited = new Set();
                const allDatabases = [];
                const allRelations = [];

                const processDatabase = async (databaseId, parentDatabaseId = null, relationPropName = null) => {
                    if (visited.has(databaseId)) {
                        addLog(`Cycle detected or already processed, skipping database ID: ${databaseId}`);
                        return;
                    }
                    visited.add(databaseId);

                    const currentDb = await getDatabaseInfo(databaseId);

                    // --- CHECK IF DATABASE ALREADY ADDED ---
                    if (!allDatabases.some(db => db.id === currentDb.id)) {
                        allDatabases.push(currentDb);
                    }

                    const currentDbName = sanitizeTableName(currentDb.title[0]?.plain_text || 'Untitled');

                    // Database-level relation
                    if (parentDatabaseId && relationPropName) {
                        const parentDb = allDatabases.find(db => db.id === parentDatabaseId);

                        if (parentDb) {
                            const parentDbName = sanitizeTableName(parentDb.title[0]?.plain_text || 'Untitled');
                            const sanitizedRelationPropName = sanitizeColumnName(relationPropName);
                            let refType = "<"; // Default to one-to-many

                            if (currentDb && currentDb.properties && currentDb.properties[relationPropName] && currentDb.properties[relationPropName].relation) {
                                if (currentDb.properties[relationPropName].relation.type === "single_property") {
                                    refType = '>';
                                } else if (currentDb.properties[relationPropName].relation.type === "dual_property") {
                                    refType = '-';
                                }
                            }

                            allRelations.push({
                                type: 'db_relation',
                                from: parentDbName,
                                to: currentDbName,
                                fromCol: sanitizedRelationPropName,
                                toCol: 'id',
                                refType: refType
                            });
                        }
                    }

                    for (const propName in currentDb.properties) {
                        const prop = currentDb.properties[propName];
                        const sanitizedPropName = sanitizeColumnName(propName);

                        if (prop.type === "relation") {
                            const relatedDbId = prop.relation.database_id;
                            addLog(`Found relation: ${propName} -> Database ID: ${relatedDbId}`);
                            await processDatabase(relatedDbId, databaseId, propName);

                        } else if (prop.type === "rollup") {
                            addLog(`Checking rollup property: ${propName}`);
                            const relationPropName = prop.rollup.relation_property_name;
                            const rolledUpPropName = prop.rollup.rollup_property_name;

                            if (relationPropName && currentDb.properties[relationPropName]?.type === "relation") {
                                const relatedDbId = currentDb.properties[relationPropName].relation.database_id;

                                if (relatedDbId) {
                                    const relatedDb = await getDatabaseInfo(relatedDbId);

                                    // --- CHECK IF RELATED DATABASE ALREADY ADDED ---
                                    if (!allDatabases.some(db => db.id === relatedDb.id)) {
                                        allDatabases.push(relatedDb);
                                    }

                                    const relatedDbName = sanitizeTableName(relatedDb.title[0]?.plain_text || "Untitled");
                                    const sanitizedRolledUpPropName = sanitizeColumnName(rolledUpPropName);

                                    if (relatedDb.properties && relatedDb.properties[rolledUpPropName]) {
                                        allRelations.push({
                                            type: 'rollup_relation',
                                            from: currentDbName,
                                            to: relatedDbName,
                                            fromCol: sanitizedPropName,
                                            toCol: sanitizedRolledUpPropName,
                                            relationProp: sanitizeColumnName(relationPropName)
                                        });
                                    } else {
                                        addLog(`Rollup property ${rolledUpPropName} not found in related database ${relatedDbId}`);
                                    }
                                } else {
                                    addLog(`Rollup points to invalid relatedDbId for relation property ${relationPropName}`);
                                }
                            } else {
                                addLog(`Rollup ${propName} is missing relation_property_name or points to a non-relation property.`);
                            }
                        } else if (prop.type === "formula") {
                            addLog(`Checking formula property: ${propName}`);
                            const formulaExpression = prop.formula.expression;
                            const propRegex = /prop\("([^"]+)"\)/g;
                            let match;

                            while ((match = propRegex.exec(formulaExpression)) !== null) {
                                const referencedPropName = match[1];
                                addLog(`Found referenced property in formula: ${referencedPropName}`);
                                const referencedProp = currentDb.properties[referencedPropName];
                                const sanitizedReferencedPropName = sanitizeColumnName(referencedPropName);

                                if (referencedProp) {
                                    if (referencedProp.type === "relation") {
                                        const relatedDbId = referencedProp.relation.database_id;
                                        addLog(`Found formula relation via prop: ${referencedPropName} -> Database ID: ${relatedDbId}`);

                                        if (relatedDbId) {
                                            await processDatabase(relatedDbId, databaseId, referencedPropName);
                                            const relatedDb = await getDatabaseInfo(relatedDbId);

                                            // --- CHECK IF RELATED DATABASE ALREADY ADDED ---
                                            if (!allDatabases.some(db => db.id === relatedDb.id)) {
                                                allDatabases.push(relatedDb);
                                            }

                                            const relatedDbName = sanitizeTableName(relatedDb.title[0]?.plain_text || 'Untitled');

                                            allRelations.push({
                                                type: 'formula_relation',
                                                from: currentDbName,
                                                to: relatedDbName,
                                                fromCol: sanitizedPropName,
                                                toCol: sanitizedReferencedPropName,
                                            });
                                        } else {
                                            addLog(`Formula ${propName} references relation property ${referencedPropName} with invalid relatedDbId`);
                                        }

                                    } else if (referencedProp.type === "rollup") {
                                        const relationPropName = referencedProp.rollup?.relation_property_name;
                                        const rolledUpPropName = referencedProp.rollup?.rollup_property_name;
                                        if (relationPropName && currentDb.properties[relationPropName]?.type === "relation") {
                                            const relatedDbId = currentDb.properties[relationPropName].relation.database_id;

                                            if (relatedDbId) {
                                                const relatedDb = await getDatabaseInfo(relatedDbId);

                                                // --- CHECK IF RELATED DATABASE ALREADY ADDED ---
                                                if (!allDatabases.some(db => db.id === relatedDb.id)) {
                                                    allDatabases.push(relatedDb);
                                                }

                                                const relatedDbName = sanitizeTableName(relatedDb.title[0]?.plain_text || "Untitled");
                                                const sanitizedRolledUpPropName = sanitizeColumnName(rolledUpPropName);

                                                if (relatedDb && relatedDb.properties && relatedDb.properties[rolledUpPropName]) {
                                                    allRelations.push({
                                                        type: 'formula_rollup',
                                                        from: currentDbName,
                                                        to: relatedDbName,
                                                        fromCol: sanitizedPropName,
                                                        toCol: sanitizedRolledUpPropName,
                                                    });
                                                } else {
                                                    addLog(`Formula ${propName} references rollup ${referencedPropName} which points to a non-existent property in related database.`);
                                                }
                                            } else {
                                                addLog(`Formula ${propName} references rollup ${referencedPropName} which points to invalid relatedDbId`);
                                            }
                                        } else {
                                            addLog(`Formula ${propName} references rollup ${referencedPropName} which is missing relation_property_name or points to a non-relation property.`);
                                        }

                                    } else {
                                        allRelations.push({
                                            type: 'formula_prop',
                                            from: currentDbName,
                                            to: currentDbName,
                                            fromCol: sanitizedPropName,
                                            toCol: sanitizedReferencedPropName,
                                        });
                                    }
                                } else {
                                    addLog(`Formula ${propName} references non-existent property: ${referencedPropName}`);
                                }
                            }
                        }
                    }
                };

                await processDatabase(startingDatabaseId);
                return { allDatabases, allRelations };
            };


            // DBML Generation
            const generateDBML = (allDatabases, allRelations) => {
                let dbml = "";

                allDatabases.forEach(dbInfo => {
                    const tableName = sanitizeTableName(dbInfo.title[0]?.plain_text || 'Untitled');
                    dbml += `Table ${tableName} {\n`;
                    dbml += `  id text [primary key]\n`;
                    for (const propName in dbInfo.properties) {
                        const prop = dbInfo.properties[propName];
                        dbml += `  ${sanitizeColumnName(propName)} ${prop.type}\n`;
                    }
                    dbml += "}\n\n";
                });

                allRelations.forEach(relation => {
                    if (relation.type === 'db_relation') {
                        dbml += `Ref: ${relation.from}.${relation.fromCol} ${relation.refType} ${relation.to}.id\n`;
                    } else if (relation.type === 'rollup_relation') {
                        dbml += `Ref: ${relation.from}.${relation.fromCol} > ${relation.to}.${relation.toCol}\n`;
                    }
                    else if (relation.type === 'formula_relation' || relation.type === 'formula_rollup' || relation.type === 'formula_prop') {
                        dbml += `Ref: ${relation.from}.${relation.fromCol} > ${relation.to}.${relation.toCol}\n`;
                    }
                });
                return dbml;
            };

            // Mermaid ER Generation
            const generateMermaidER = (allDatabases, allRelations) => {
                let mermaid = "erDiagram\n";

                allDatabases.forEach(db => {
                    const tableName = sanitizeTableName(db.title[0]?.plain_text || 'Untitled');
                    mermaid += `    ${tableName} {\n`;
                    mermaid += `        text id\n`;
                    for (const propName in db.properties) {
                        if (db.properties[propName].type === "relation") continue;
                        mermaid += `        ${db.properties[propName].type} ${sanitizeColumnName(propName)}\n`;
                    }
                    mermaid += "    }\n\n";
                });

                allRelations.forEach(relation => {
                    if (relation.type === 'db_relation') {
                        let connector = "||--o{";
                        if (relation.refType === "-")
                            connector = "||--||";
                        mermaid += `    ${relation.from} ${connector} ${relation.to} : ${relation.fromCol}\n`;
                    }
                    else if (relation.type === 'rollup_relation') {
                        mermaid += `    ${relation.from} ||--|| ${relation.to} : "${relation.fromCol} rolls up ${relation.toCol}"\n`;

                    } else if (relation.type === 'formula_relation' || relation.type === 'formula_rollup' || relation.type === 'formula_prop') {
                        mermaid += `    ${relation.from} ||--|| ${relation.to} : "${relation.fromCol} uses ${relation.toCol}"\n`;
                    }
                });

                return mermaid;
            };


            // Event Listeners
            document.getElementById('diagram-form').addEventListener('input', (e) => { if (e.target.tagName === 'INPUT') clearError(e.target); });
            document.getElementById('workerUrl').addEventListener('input', () => { clearError(document.getElementById('workerUrl')); checkWorkerUrl(); });
            document.getElementById('workerToken').addEventListener('input', () => { clearError(document.getElementById('workerToken')); checkWorkerUrl(); });
            document.getElementById('reset-button').addEventListener('click', resetForm);
            document.getElementById('databaseSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const databases = JSON.parse(localStorage.getItem('nomsDatabases') || '[]');
                const filtered = databases.filter(db => db.title?.[0]?.plain_text.toLowerCase().includes(searchTerm));
                populateDropdowns(filtered);
            });

            document.getElementById('diagram-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (isProcessing) return;

                const databaseId = document.getElementById('databaseSelect').value;
                if (!databaseId) { showError(document.getElementById('databaseSelect'), 'Database is required'); return; }
                if (!isWorkerConfigComplete()) {
                    showError(document.getElementById('workerUrl'), "Worker URL is required");
                    showError(document.getElementById('workerToken'), "Worker Token is required");
                    return;
                }

                isProcessing = true;
                document.getElementById('submit-button').disabled = true;
                document.getElementById('submit-button-text').classList.add('opacity-0');
                document.getElementById('loading-spinner').classList.remove('hidden');
                document.getElementById('diagram-form').classList.add('hidden');
                document.getElementById('output-section').classList.remove('hidden');
                document.getElementById('diagramOutput').value = '';

                try {
                    const { allDatabases, allRelations } = await extractDatabaseRelationships(databaseId);
                    const diagramType = document.querySelector('input[name="diagramType"]:checked').value;
                    const generateDiagram = diagramType === "mermaid" ? generateMermaidER : generateDBML;
                    document.getElementById('diagramOutput').value = generateDiagram(allDatabases, allRelations);

                    addLog(`${diagramType === "mermaid" ? "Mermaid ER Diagram" : "DBML"} Generated!`);
                    document.getElementById('pasteMessage').innerHTML = diagramType === "mermaid"
                        ? 'Paste your Mermaid diagram at <a href="https://mermaid.live/" target="_blank">mermaid.live</a> or a notion mermaid code block.'
                        : 'Paste your DBML diagram at <a href="https://dbdiagram.io/home" target="_blank">dbdiagram.io/home</a> or <a href="https://databasediagram.com/app" target="_blank">databasediagram.com/app</a> (select DBML).';
                    document.getElementById('pasteMessage').classList.add('text-sm', 'p-2', 'border-2', 'border-dashed', 'border-gray-500');
                    document.getElementById('copy-button').disabled = false;

                } catch (error) {
                    document.getElementById('diagramOutput').value = `Error: ${error.message}`;
                    addLog(`Error generating diagram: ${error.message}`);
                } finally {
                    isProcessing = false;
                    document.getElementById('submit-button').disabled = false;
                    document.getElementById('submit-button-text').classList.remove("opacity-0");
                    document.getElementById('loading-spinner').classList.add('hidden');
                    document.getElementById('reset-button').classList.remove('hidden');
                }
            });

            document.getElementById('copy-button').addEventListener('click', () => {
                document.getElementById('diagramOutput').select();
                document.execCommand('copy');
                document.getElementById('copy-button').textContent = "Copied!";
                setTimeout(() => {
                    document.getElementById('copy-button').innerHTML = `  <svg class="mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg> <span>Copy to Clipboard</span>`;
                }, 2000);
            });

            document.getElementById('refreshDatabases').addEventListener('click', async () => {
                if (!isWorkerConfigComplete()) {
                    showError(document.getElementById('workerUrl'), 'Worker URL and Token are required');
                    showError(document.getElementById('workerToken'), 'Worker URL and Token are required');
                    return;
                }
                try {
                    const databases = await fetchDatabases();
                    populateDropdowns(databases);
                } catch (error) {
                    console.error('Failed to refresh databases:', error);
                    addLog(`Error refreshing databases: ${error.message}`);
                }
            });


            // Initialization
            const databases = JSON.parse(localStorage.getItem('nomsDatabases') || '[]');
            if (databases.length) populateDropdowns(databases);
            await checkAuthStatus();
            loadWorkerConfig();
            checkWorkerUrl();
            updateUIHeader(document.getElementById('user-info'));
        });
    </script>
    <script src="./js/loadKofi.js"></script>
</body>

</html>